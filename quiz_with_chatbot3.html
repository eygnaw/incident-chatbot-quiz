<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clinical Governance Quiz with IDT Chatbot</title>
  <!-- Dialogflow CX Messenger -->
  <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0 380px 0 0;background:#f9fafb;color:#111;box-sizing:border-box}
    h1,h2{margin-top:0}
    .container{max-width:800px;margin:0 auto;padding:2rem}
    .page{display:none}
    .page.active{display:block}
    .btn{display:inline-block;padding:.6rem 1.2rem;background:#1e40af;color:#fff;border:none;border-radius:4px;font-size:1rem;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .timer{font-weight:bold;margin-bottom:1rem}
    .question{font-weight:bold;margin-bottom:.75rem}
    .options label{display:block;margin-bottom:.4rem;cursor:pointer}
    table{border-collapse:collapse;width:100%;margin-bottom:1rem}
    th,td{border:1px solid #ddd;padding:.5rem;text-align:center}
    th{background:#e5e7eb}
    df-messenger{position:fixed;bottom:0;right:0;top:0;width:350px;max-width:100%;z-index:999;--df-messenger-font-color:#000;--df-messenger-font-family:Google Sans;--df-messenger-chat-background:#f3f6fc;--df-messenger-message-user-background:#d3e3fd;--df-messenger-message-bot-background:#fff}
    @media(max-width:900px){body{padding:0}df-messenger{width:100%;height:50%;left:0;right:0;top:auto}}
  </style>
</head>
<body>
  <!-- INTRO -->
  <div id="page1" class="page active container">
    <h1>Clinical Governance Quiz</h1>
    <p>The following scenarios are adapted from the <em>Incident Decision Tree</em>. Choose the management option you judge most appropriate. You can move back to review earlier scenarios, but once you proceed your previous selections are locked.</p>
    <p>The IDT chatbot remains available on the right.</p>
    <button class="btn" id="startBtn">Start Quiz</button>
  </div>

  <!-- QUESTION WIZARD -->
  <div id="page2" class="page container">
    <div class="timer">Quiz time: <span id="timer">0</span> s</div>
    <div id="questionContainer"></div>
    <div style="margin-top:1.5rem;display:flex;justify-content:space-between">
      <button class="btn" id="prevBtn" disabled>Previous</button>
      <button class="btn" id="nextBtn" disabled>Next</button>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="page3" class="page container">
    <h2>Your Results</h2>
    <p id="scoreLine"></p>
    <p id="timeLine"></p>
    <div id="review"></div>
    <button class="btn" id="toFeedbackBtn">Continue to Feedback</button>
  </div>

  <!-- FEEDBACK -->
  <div id="page4" class="page container">
    <h2>Feedback</h2>
    <p>Rate each statement 1 (strongly disagree) – 5 (strongly agree).</p>
    <form id="feedbackForm">
      <table><thead><tr><th>Metric</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead><tbody id="feedbackBody"></tbody></table>
      <button class="btn" type="submit">Submit & Finish</button>
    </form>
    <div id="thanks" style="display:none;font-weight:bold"></div>
  </div>

  <!-- Chatbot -->
  <df-messenger location="europe-west2" project-id="incident-decision-tree-as-sppe" agent-id="dfdb170b-7667-470a-81c3-3dfaa2488c5b" environment="draft" language-code="en" allow-feedback="all">
    <df-messenger-chat chat-title="IDT"></df-messenger-chat>
  </df-messenger>

  <script>
    /* =========================== CONFIG =========================== */
    const feedbackQuestions=[
      {id:'understood_input',label:'The agent understood what I wrote'},
      {id:'understood_nl',label:'The agent can understand natural language'},
      {id:'intelligent',label:'The agent is intelligent'},
      {id:'met_expectations',label:'The agent’s capabilities met my expectations'},
      {id:'broken_flow',label:'The agent’s answers broke my line of thought'},
      {id:'difficult_input',label:'I had difficulty phrasing my questions'},
      {id:'info_available',label:'I had all information needed to engage'},
      {id:'learned_more',label:'I learned more than I initially knew'},
      {id:'questions_unanswered',label:'There were questions the agent could not answer'},
      {id:'fluid',label:'The conversation felt fluid'},
      {id:'tasks_easy',label:'I completed my tasks without effort'},
      {id:'lost_for_words',label:'I did not know what to say next'},
      {id:'helped_tasks',label:'The agent helped me conclude my tasks'}
    ];

    /* =========================== STATE =========================== */
    const state={current:0,answers:[],locked:[],quizStart:null};
    let questions=[];

    /* =========================== DOM =========================== */
    const $=id=>document.getElementById(id);
    const qContainer=$('questionContainer');
    const timerEl=$('timer');

    /* =========================== TIMER =========================== */
    let tick;
    function startTimer(){state.quizStart=Date.now();tick=setInterval(()=>{timerEl.textContent=Math.floor((Date.now()-state.quizStart)/1000);},250);}    
    function stopTimer(){clearInterval(tick);}    

    /* =========================== LOAD QUESTIONS =========================== */
    async function loadQuestions(){
      const res=await fetch('questions.json');
      questions=await res.json();
    }

    /* =========================== RENDER QUESTION =========================== */
    function renderQuestion(idx){
      const q=questions[idx];
      qContainer.innerHTML='';
      const p=document.createElement('p');p.className='question';p.textContent=q.text;qContainer.appendChild(p);
      const opts=document.createElement('div');opts.className='options';
      q.options.forEach((opt,i)=>{
        const lab=document.createElement('label');
        const r=document.createElement('input');r.type='radio';r.name='opt';r.value=i;
        if(state.answers[idx]!==undefined&&state.answers[idx]===i)r.checked=true;
        if(state.locked[idx])r.disabled=true;
        r.addEventListener('change',()=>{$('nextBtn').disabled=false;});
        lab.appendChild(r);
        lab.append(' '+String.fromCharCode(65+i)+' — '+opt);
        opts.appendChild(lab);
      });
      qContainer.appendChild(opts);
      $('prevBtn').disabled=idx===0;
      $('nextBtn').disabled=true;
      if(state.answers[idx]!==undefined&&!state.locked[idx])$('nextBtn').disabled=false;
      $('nextBtn').textContent=idx===questions.length-1?'Submit':'Next';
    }

    /* =========================== NAV EVENTS =========================== */
    $('startBtn').onclick=async()=>{await loadQuestions();state.answers=new Array(questions.length);state.locked=new Array(questions.length).fill(false);show('page2');startTimer();renderQuestion(0);}    

    $('prevBtn').onclick=()=>{if(state.current>0){state.current--;renderQuestion(state.current);}};

    $('nextBtn').onclick=()=>{
      // save answer
      const sel=document.querySelector('input[name="opt"]:checked');
      if(!sel)return;state.answers[state.current]=parseInt(sel.value,10);state.locked[state.current]=true;
      if(state.current===questions.length-1){grade();return;}
      state.current++;renderQuestion(state.current);
    };

    /* =========================== GRADE & REVIEW =========================== */
    function grade(){stopTimer();const corrects=questions.filter((q,i)=>q.correctIndex===state.answers[i]).length;$('scoreLine').textContent=`Score: ${corrects} / ${questions.length}`;$('timeLine').textContent=`Total time: ${timerEl.textContent} s`;
      const rev=$('review');rev.innerHTML='';questions.forEach((q,i)=>{const div=document.createElement('div');div.style.marginBottom='1rem';
        const stem=document.createElement('p');stem.textContent=q.text;div.appendChild(stem);
        const corr=document.createElement('p');corr.innerHTML='<strong>Correct:</strong> '+String.fromCharCode(65+q.correctIndex)+' – '+q.options[q.correctIndex];div.appendChild(corr);
        if(q.note){const note=document.createElement('p');note.innerHTML='<em>Note – '+q.note+'</em>';div.appendChild(note);}rev.appendChild(div);});
      show('page3');
    }

    /* =========================== FEEDBACK FORM =========================== */
    const fbBody=$('feedbackBody');
    feedbackQuestions.forEach(f=>{const tr=document.createElement('tr');const td=document.createElement('td');td.textContent=f.label;tr.appendChild(td);for(let i=1;i<=5;i++){const t=document.createElement('td');const r=document.createElement('input');r.type='radio';r.name=f.id;r.value=i;t.appendChild(r);tr.appendChild(t);}fbBody.appendChild(tr);});

    $('toFeedbackBtn').onclick=()=>{show('page4');};

    $('feedbackForm').onsubmit=e=>{e.preventDefault();$('thanks').textContent='Thank you – feedback saved.';e.target.style.display='none';};

    /* =========================== UTIL =========================== */
    function show(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));$(id).classList.add('active');}
  </script>
</body>
</html>
